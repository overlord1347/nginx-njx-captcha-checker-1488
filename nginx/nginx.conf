load_module modules/ngx_http_js_module.so;

events {
    worker_connections 1024;
}

http {
    js_import http from /etc/nginx/http.js;
    js_set $captcha_passed http.check_captcha;

    server {
        listen 8080;

        root /usr/share/nginx/html;

        # Страница с капчей (всегда доступна)
        location = /captcha {
            try_files /captcha.html =404;
        }

        # Статические файлы (favicon и т.д.)
        location ~ \.(ico|css|js|png|jpg|jpeg|gif|svg)$ {
            try_files $uri =404;
        }

        # Главная страница - проверяем куку
        location / {
            # Если куки нет - редирект на капчу
            if ($captcha_passed = "0") {
                return 302 /captcha;
            }

            # Если кука есть - отдаём success.html
            try_files /success.html =404;
        }
    }
}
