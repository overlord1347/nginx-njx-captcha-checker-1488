load_module modules/ngx_http_js_module.so;

events { worker_connections 1024; }

http {
    js_import http from /etc/nginx/http.js;
    js_set $captcha_passed http.check_captcha;

    # добавим простой формат логов для отладки
    log_format debug '$remote_addr - $remote_user [$time_local] "$request" '
                     'cookie="$http_cookie" captcha=$captcha_passed status=$status';

    access_log /var/log/nginx/access.log debug;
    error_log  /var/log/nginx/error.log info;

    server {
        listen 8080;
        root /usr/share/nginx/html;

        # внутренний проксирующий endpoint для валидации токена
        location = /_verify_captcha {
            internal;
            proxy_pass https://www.google.com/recaptcha/api/siteverify;
            proxy_ssl_server_name on;
            proxy_set_header Host www.google.com;
            proxy_set_header Content-Type application/x-www-form-urlencoded;
            proxy_method POST;
        }

        location = /captcha { try_files /captcha.html =404; }

        location ~ \.(ico|css|js|png|jpg|jpeg|gif|svg)$ { try_files $uri =404; }

        location / {
            if ($captcha_passed = "0") {
                return 302 /captcha;
            }
            try_files /success.html =404;
        }
    }
}
